{% extends 'base.html' %}

{% block body %}
<div id="sidebar">

    <form action="?" method="post">
        <table>

            <tr>
                <th>集計検索</th>
                <th></th>
            </tr>
            <tr>
                <td>集計単位:</td>
                <td>
                    <select name="syukeijo">
                        <option value="jo" selected>場</option>
                        <option value="sekou">施行者</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>年度:</td>
                <td>
                    <select name="year">
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024" selected>2024</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>月:</td>
                <td>
                    <select name="month">
                        <option value=""></option>
                        {% for month in [4,5,6,7,8,9,10,11,12,1,2,3] %}
                        <option value={{"{:02}".format(month)}}>{{month}}月</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td>グレード:</td>
                <td>
                    <select name="grade">
                        <option value="" selected></option>
                        <option value="SG">SG</option>
                        <option value="G1">G1</option>
                        <option value="G2">G2</option>
                        <option value="G3">G3</option>
                        <option value="一般">一般</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>series詳細:</td>
                <td>
                    <style>
                        .box select {
                            width: 60px;
                        }
                    </style>
                    <div class="box">
                        <select name="series">
                            <option value="" selected></option>
                            <option value="SG">SG</option>
                            <option value="全国発売G1">全国発売G1</option>
                            <option value="G1">その他G1</option>
                            <option value="G2">G2</option>
                            <option value="AL-VS（女子戦）">AL-VS(女子戦)</option>
                            <option value="マスターズ">マスターズ</option>
                            <option value="それ以外G3">その他G3</option>
                            <option value="ルーキーシリーズ">ルーキーシリーズ</option>
                            <option value="男女Ｗ優勝戦">男女Ｗ優勝戦</option>
                            <option value="女子ＶＳルーキー">女子ＶＳルーキー</option>
                            <option value="3Days">3Days</option>
                            <option value="一般競走">その他一般競走</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>開催区分:</td>
                <td>
                    <style>
                        .box select {
                            width: 60px;
                        }
                    </style>
                    <div class="box">
                        <select name="kubun">
                            <option value="" selected></option>
                            <option value="M">モーニング</option>
                            <option value="D">デイ</option>
                            <option value="S">サマータイム</option>
                            <option value="N">ナイター</option>
                            <option value="MN">ミッドナイト</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>集計区分:</td>
                <td>
                    <select name="syukei">
                        <option value="avg">平均</option>
                        <option value="sum" selected>合計</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>ソート:</td>
                <td>
                    <style>
                        .box select {
                            width: 60px;
                        }
                    </style>
                    <div class="box">
                        <select name="sort">
                            <option value="jocodo" selected>場コード</option>
                            <option value="desc">降順</option>
                            <option value="asc">昇順</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="col text-right">
                        <button type="submit" class="btn btn-outline-primary btn-sm" name="no1"
                            formaction="/">実行</button>
                    </div>
                </td>
            </tr>

        </table>
        <!--<div class="col text-center">-->

        <hr color="black">
        <table>
            <tr>
                <th width="100">日付検索</th>
                <th></th>
            </tr>
            <tr>
                <td>
                    日付：
                </td>
                <td>
                    <!-- ここにカレンダー表示用のテキストボックスを追加 -->
                    <input type="text" class="form-control" id="date_sample" name="datestr">
                    <!-- bootstrap-datepickerのjavascriptコード -->
                    <script>
                        $('#date_sample').datepicker({
                            format: 'yyyymmdd'
                        });
                    </script>
                </td>

            </tr>
            <tr>
                <td>
                    場：
                </td>
                <td>
                    <select name="jo">
                        <option value="" selected></option>
                        {% set jo24 = ['桐生', '戸田', '江戸川', '平和島', '多摩川', '浜名湖', '蒲郡', '常滑', '津', '三国', 'びわこ',
                        '住之江', '尼崎', '鳴門', '丸亀', '児島', '宮島', '徳山', '下関', '若松', '芦屋', '福岡', '唐津', '大村']%}
                        {% for jo in jo24%}
                        {% set jono= "{:02}".format(loop.index) + ':'+jo %}
                        <option value={{jono}}>{{jono}}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <div class="col text-right">
                        <button type="submit" class="btn btn-outline-primary btn-sm" name="no2"
                            formaction="/">実行</button>
                    </div>
                </td>
            </tr>
        </table>

        <hr color="black">
        <table>
            <tr>
                <th width="120">競走検索</th>
                <th></th>
            </tr>
            <tr>
                <td>
                    SG・PG1等:
                </td>
                <td width="90">
                    <style>
                        .box select {
                            width: 90px;
                        }
                    </style>
                    <div class="box">
                        <select name="title">
                            <option value="" selected></option>
                            {% set SG_title =
                            ['ボートレース　オールスター','グランドチャンピオン','オーシャンカップ','ボートレースメモリアル','ボートレースダービー','チャレンジカップ／Ｇ２レディースＣＣ','グランプリ／グランプリシリーズ','ボートレースクラシック','マスターズチャンピオン','レディースチャンピオン','ヤングダービー','クイーンズクライマックス／Ｇ３ＱＣシリーズ','ＢＢＣトーナメント','レディースオールスター','全国ボートレース甲子園','３Ｄａｙｓ',
                            ]%}
                            {% for title in SG_title%}
                            <option value={{title}}>{{title}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </td>
                <td>
                    <div class="col text-right">
                        <button type="submit" class="btn btn-outline-primary btn-sm" name="no3"
                            formaction="/">実行</button>
                    </div>
                </td>
            </tr>

        </table>

        <hr color="black">

        <table>
            <tr>
                <th width="160">series検索</th>
                <th width="80"></th>
            </tr>
            <tr>
                <td>年度:</td>
                <td width="80">
                    <style>
                        .box select {
                            width: 80px;
                        }
                    </style>
                    <div class="box">
                        <select name="year2">
                            <option value="2016">2016</option>
                            <option value="2017">2017</option>
                            <option value="2018">2018</option>
                            <option value="2019">2019</option>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024" selected>2024</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>series詳細:</td>
                <td width="80">
                    <style>
                        .box select {
                            width: 80px;
                        }
                    </style>
                    <div class="box">
                        <select name="series2">
                            <option value="" selected></option>
                            <option value="AL-VS（女子戦）">AL-VS(女子戦)</option>
                            <option value="マスターズ">マスターズ</option>
                            <option value="ルーキーシリーズ">ルーキーシリーズ</option>
                            <option value="男女Ｗ優勝戦">男女Ｗ優勝戦</option>
                            <option value="女子ＶＳルーキー">女子ＶＳルーキー</option>
                        </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>開催区分:</td>
                <td width="80">
                    <style>
                        .box select {
                            width: 80px;
                        }
                    </style>
                    <div class="box">
                        <select name="kubun2">
                            <option value="" selected></option>
                            <option value="M">モーニング</option>
                            <option value="D">デイ</option>
                            <option value="S">サマータイム</option>
                            <option value="N">ナイター</option>
                            <option value="MN">ミッドナイト</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="col text-right">
                        <button type="submit" class="btn btn-outline-primary btn-sm" name="no4"
                            formaction="/">実行</button>
                    </div>
                </td>
            </tr>
        </table>
        <hr color="black">
        <table>
            <tr>
                <th>発売場検索</th>
                <th></th>
            </tr>
            <tr>
                <td>始期:</td>
                <td>
                    <select name="year5_1">
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024" selected>2024</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>終期:</td>
                <td>
                    <select name="year5_2">
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024" selected>2024</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>グレード:</td>
                <td>
                    <select name="grade5">
                        <option value="" selected></option>
                        <option value="SG">SG</option>
                        <option value="G1">G1</option>
                        <option value="G2">G2</option>
                        <option value="G3">G3</option>
                        <option value="一般">一般</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>開催区分:</td>
                <td>
                    <style>
                        .box select {
                            width: 80px;
                        }
                    </style>
                    <div class="box">
                        <select name="kubun5">
                            <option value="" selected></option>
                            <option value="M">モーニング</option>
                            <option value="D">デイ</option>
                            <option value="S">サマータイム</option>
                            <option value="N">ナイター</option>
                            <option value="MN">ミッドナイト</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="col text-right">
                        <button type="submit" class="btn btn-outline-primary btn-sm" name="no5"
                            formaction="/">実行</button>
                    </div>
                </td>
            </tr>
        </table>
        本場開催分は除外
        <hr color="black">
    </form>
    <form>
        <button type="submit" class="btn btn-info" name="no6"
                        formaction="/no6">期間集計</button>
        <button type="submit" class="btn btn-info" name="no7"
                        formaction="/no7">SG・PG1日別</button>
    </form>
</div>

<h4 align="center">実行結果</h4>

{% if no == 'no1' %}

<div class="card" style=" width: 600px;margin: auto;">
    <div class="card-header">
        {% set ns = namespace(amount = 0) %}
        {% for row in query%}
        {% set ns.amount = ns.amount + row[1]|int %}
        {% endfor %}
        <h5>期間合計：{{"{:,}".format(ns.amount |int //100 * 100)}}</h5>
    </div>
    <div class="card-body">
        <h5 class="card-title">
            <table border="1">
                <tr class="border border-dark" align="center">
                    <th class="border border-dark">開催場(施行者)</th>
                    <th class="border border-dark">総売上</th>
                </tr>
                {% for row in query%}
                <tr class="border border-dark" align="left">
                    <td class="border border-dark" align="center">{{row[0]}}</td>
                    <td class="border border-dark" align="right" style="font-family: monospace">{{"{:,}".format(row[1]|int //100 * 100)}}</td>
                </tr>
                {% endfor %}
            </table>

        </h5>
    </div>
</div>

{% elif no == 'no2' %}
<div class="card" style=" width: 1200px;margin: auto;">
    <div class="card-header">
        {% set ns = namespace(amount = 0,count=0,grade='',kubun='',title='') %}
        {% for row in query%}
        {% set ns.amount = ns.amount + row[9]|int %}
        {% set ns.grade = row[8] %}
        {% set ns.kubun = row[6] %}
        {% set ns.title = row[7] %}
        {% set ns.count = loop.index %}
        {% endfor %}
        <h5>競走名称：{{ns.title}}</h5>
        <h5>グレード：{{ns.grade}}</h5>
        <h5>開催区分：{{ns.kubun}}</h5>
        <h5>節間合計：{{"{:,}".format(ns.amount)}}</h5>
        <h5>節間平均：{{"{:,}".format((ns.amount / ns.count) |int)}}</h5>
    </div>
    <div class="card-body">
        <h5 class="card-title">
            <table border="1">
                <tr align="center">
                    <th>開催日付</th>
                    <th>開催場</th>
                    <th>開催施行者</th>
                    <th>売上</th>
                </tr>
                {% for row in query%}
                <tr align="center">
                    <td>{{row[0]}}</td>
                    <td>{{row[1]}}</td>
                    <td>{{row[2]}}</td>
                    <td>{{"{:,}".format(row[9])}}</td>
                </tr>
                {% endfor %}
            </table>
        </h5>
    </div>
</div>
{% elif no == 'no3' %}
<!--[0:日付,1:競走場,2:施行者,3:グレード,4:開催区分,5:競走名,6:総売上,7:本場売上,8:電話売上]-->
<div class="card" style=" width: 1300px;margin: auto;font-size: 20px;font-size-adjust: 0.6;">
    <div class="card-header">
        {% set ns = namespace(amount = 0, count=0) %}
        {% for row in datalist %}
        {% set ns.amount = ns.amount + row[6]|int %}
        {% set ns.count = loop.index %}
        {% endfor %}
        <marquee behavior="alternate">
            <h5>通算売上合計：{{"{:,}".format(ns.amount)}}</h5>
            <h5>通算売上平均：{{"{:,}".format((ns.amount / ns.count) |int)}}</h5>
        </marquee>
    </div>
    <div class="card-body">
        <h6 class="card-title">
            <table class="border border-dark">
                <tr align="center" class="border border-dark">
                    <th class="border border-dark">開催日付</th>
                    <th class="border border-dark">開催場</th>
                    <th class="border border-dark">開催施行者</th>
                    <th class="border border-dark">グレード詳細</th>
                    <th class="border border-dark">区分</th>
                    <th class="border border-dark">競走名称</th>
                    <th class="border border-dark">総売上</th>
                    <th class="border border-dark">本場売上</th>
                    <th class="border border-dark">電話売上</th>
                    <th class="border border-dark">場外売上</th>
                </tr>
                {% set ns2 = namespace(previous = '-') %}
                {% set ns3 = namespace(amount2 = 0,amount3 = 0,amount4 = 0,amount5 = 0) %}
                {% for row in datalist%}
                <!--ここがポイント-->
                {% if ns2.previous != '-' and row[5] != ns2.previous %}
                <tr align="center">
                    <td class="border border-dark">---</td>
                    <td class="border border-dark">---</td>
                    <td class="border border-dark">---</td>
                    <td class="border border-dark">---</td>
                    <td class="border border-dark">---</td>
                    <td class="border border-dark">節間合計</td>
                    <td align="right" style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount2)}}</b></td>
                    <td align="right" style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount3)}}</b></td>
                    <td align="right" style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount4)}}</b></td>
                    <td align="right" style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount5)}}</b></td>
                    {% set ns3.amount2 = 0 %}
                    {% set ns3.amount3 = 0 %}
                    {% set ns3.amount4 = 0 %}
                    {% set ns3.amount5 = 0 %}
                </tr>
                {% endif %}

                <tr align="center">
                    <td class="border border-dark">{{row[0]}}</td>
                    <td class="border border-dark">{{row[1][3:]}}</td>
                    <td class="border border-dark">{{row[2]}}</td>
                    <td class="border border-dark">{{row[3]}}</td>
                    <td class="border border-dark">{{row[4]}}</td>
                    <td class="border border-dark">{{row[5]}}</td>
                    <td align="right" class="border border-dark" style="font-family: monospace">{{"{:,}".format(row[6])}}</td>
                    <td align="right" class="border border-dark" style="font-family: monospace">{{"{:,}".format(row[7]|int)}}</td>
                    <td align="right" class="border border-dark" style="font-family: monospace">{{"{:,}".format(row[8]|int)}}</td>
                    <td align="right" class="border border-dark" style="font-family: monospace">{{"{:,}".format((row[6] - row[7] - row[8])|int)}}</td>
                    {% set ns3.amount2 = ns3.amount2 + row[6]|int %}
                    {% set ns3.amount3 = ns3.amount3 + row[7]|int %}
                    {% set ns3.amount4 = ns3.amount4 + row[8]|int %}
                    {% set ns3.amount5 = ns3.amount5 + (row[6] - row[7] - row[8])|int %}
                </tr>
                {% set ns2.previous = row[5] %}
                {% endfor %}
                <tr align="center">
                    <td class="border border-dark" style="font-family: monospace">---</td>
                    <td class="border border-dark" style="font-family: monospace">---</td>
                    <td class="border border-dark" style="font-family: monospace">---</td>
                    <td class="border border-dark" style="font-family: monospace">---</td>
                    <td class="border border-dark" style="font-family: monospace">---</td>
                    <td class="border border-dark" style="font-family: monospace">節間合計</td>
                    <td style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount2)}}</b></td>
                    <td style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount3)}}</b></td>
                    <td style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount4)}}</b></td>
                    <td style="color: blue;font-family: monospace;" class="border border-dark"><b>{{"{:,}".format(ns3.amount5)}}</b></td>
                </tr>
            </table>
            ※戸田、平和島、尼崎、児島でのBTSシステムを利用した外向売上については場外に計上している
        </h6>
    </div>
</div>

{% elif no =='no4' %}
<div class="card" style=" width: 1200px;margin: auto;font-size: 20px;font-size-adjust: 0.6;">
    <div class="card-header">
        {% set ns = namespace(amount = 0, count=0) %}
        {% for row in query%}
        {% set ns.amount = ns.amount + row[9]|int %}
        {% set ns.count = loop.index %}
        {% endfor %}
        <marquee behavior="alternate">
            <h5>通算売上合計：{{"{:,}".format(ns.amount)}}</h5>
            <h5>通算売上平均：{{"{:,}".format((ns.amount / ns.count) |int)}}</h5>
        </marquee>
    </div>
    <div class="card-body">
        <h6 class="card-title">
            <table border="1">
                <tr align="center">
                    <th>開催日付</th>
                    <th>開催場</th>
                    <th>開催施行者</th>
                    <th>グレード詳細</th>
                    <th>区分</th>
                    <th>競走名称</th>
                    <th>売上</th>
                </tr>
                {% set ns2 = namespace(previous = '-') %}
                {% set ns3 = namespace(amount2 = 0) %}
                {% for row in query%}
                <!--ここがポイント-->
                {% if ns2.previous != '-' and row[7] != ns2.previous %}
                <tr align="center">
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>節間合計</td>
                    <td style="color: blue;">{{"{:,}".format(ns3.amount2)}}</td>
                    {% set ns3.amount2 = 0 %}
                </tr>
                {% endif %}

                <tr align="center">
                    <td>{{row[0]}}</td>
                    <td>{{row[1][3:]}}</td>
                    <td>{{row[2]}}</td>
                    <td>{{row[8]}}</td>
                    <td>{{row[6]}}</td>
                    <td>{{row[7]}}</td>
                    <td align="right">{{"{:,}".format(row[9])}}</td>
                    {% set ns3.amount2 = ns3.amount2 + row[9]|int %}
                </tr>
                {% set ns2.previous = row[7] %}
                {% endfor %}
                <tr align="center">
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>---</td>
                    <td>節間合計</td>
                    <td style="color: blue;">{{"{:,}".format(ns3.amount2)}}</td>
                </tr>
            </table>
        </h6>
    </div>
</div>

{% elif no == 'no5' %}
<div class="card" style=" width: 600px;margin: auto;font-size: 12px;font-size-adjust: 0.6;">
    <div class="card-header">
        <h5>始期：{{year5_1}}</h5>
        <h5>終期：{{year5_2}}</h5>
        <h5>グレード：{{grade5}}</h5>
        <h5>開催区分：{{kubun5}}</h5>
    </div>
    <div class="card-body">
        <h5 class="card-title">
            <table border="1">
                <tr align="center">
                    <th class="border border-dark">発売場</th>
                    <th class="border border-dark">売上</th>
                </tr>
                {% for row in query%}
                <tr align="center">
                    <td class="border border-dark">{{row[1][4:]}}</td>

                    <td align="right" style="font-family: monospace" class="border border-dark">{{"{:,}".format(row[8]|int //100 * 100)}}</td>
                </tr>
                {% endfor %}
            </table>
        </h5>
    </div>
</div>
{%endif%}

{% endblock %}